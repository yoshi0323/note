# Note下書き投稿システム

note.comに下書き投稿できるシステムです。

## 技術スタック

- フロントエンド: React
- バックエンド: Python (FastAPI)
- ホスティング: Firebase Hosting
- 認証: 固定パスワード（note123）
- LLM: OpenAI / Google Gemini
- トレンド取得: twscrape（X/Twitter）

## セットアップ

### 前提条件

- Python 3.8以上
- Node.js 16以上
- npm または yarn
- Firebase CLI（デプロイ時のみ）

### バックエンド

1. バックエンドディレクトリに移動
```bash
cd backend
```

2. 依存関係をインストール
```bash
pip install -r requirements.txt
```

3. Playwrightブラウザをインストール
```bash
python -m playwright install chromium
```

4. サーバーを起動
```bash
uvicorn main:app --reload
```

バックエンドは `http://localhost:8000` で起動します。

### フロントエンド

1. フロントエンドディレクトリに移動
```bash
cd frontend
```

2. 依存関係をインストール
```bash
npm install
```

3. 開発サーバーを起動
```bash
npm start
```

フロントエンドは `http://localhost:3000` で起動します。

### Firebase Hostingへのデプロイ

詳細なデプロイ手順は`DEPLOY.md`を参照してください。

**クイックデプロイ手順:**

1. Firebase CLIをインストール（未インストールの場合）
```bash
npm install -g firebase-tools
```

2. Firebaseにログイン
```bash
firebase login
```

3. Firebaseプロジェクトの作成（重要）
   - **Firebaseコンソール（https://console.firebase.google.com/）でプロジェクトを作成**
   - プロジェクトIDを`note-c801b`に設定（または任意のID）
   - Hostingを有効化（プロジェクト作成後、左メニューから「Hosting」→「始める」）
   - プロジェクトを選択: `firebase use note-c801b`
   
   **注意:** `firebase init`は実行しないでください。既に設定ファイルが作成済みです。

4. バックエンドURLを設定（本番環境の場合）
   - `frontend/.env.production`ファイルを手動で作成（`.gitignore`に含まれています）:
   ```
   REACT_APP_API_URL=https://your-backend-url.com
   ```

5. フロントエンドをビルド
```bash
cd frontend
npm install
npm run build
```

6. Firebase Hostingにデプロイ
```bash
cd ..
firebase deploy --only hosting
```

**重要:** 本番環境で使用するには、**バックエンドも本番環境にデプロイする必要があります**。

- Firebase Hostingにデプロイしたフロントエンドから、ユーザーのローカルバックエンド（localhost）にはアクセスできません
- バックエンドは**Render（完全無料・推奨）**、Fly.io、Replitなどのクラウドサービスにデプロイしてください
- 詳細なデプロイ手順は`DEPLOY.md`または`RENDER_DEPLOY.md`を参照してください

**注意事項:**
- デプロイ前に、バックエンドのURLを環境変数で設定する必要があります
- 本番環境では、`REACT_APP_API_URL`環境変数でバックエンドURLを指定してください
- ローカル開発時は`http://localhost:8000`がデフォルトで使用されます

## 使い方

1. ログイン
   - パスワード: `note123`

2. 設定
   - Note ID（メールアドレス）とパスワードを入力
   - OpenAI API Key または Gemini API Key を入力

3. プロンプト設定（オプション）
   - 文章の表現（明るい、丁寧、フランク）
   - 文章の長さ（1000-2000、2000-3000、3000-5000文字）
   - その他条件

4. 記事生成
   - **テーマ別生成**: テーマを選択して記事を生成
   - **Xトレンド生成**: Xのトレンドとテーマを選択して記事を生成
   - **手動編集**: タイトルと本文を手動で入力

5. 下書き投稿
   - 生成した記事を選択
   - 「今すぐ投稿」ボタンをクリック
   - **自動でブラウザが起動し、note.comにログイン→タイトル/本文入力→下書き保存が実行されます**
   - または投稿時刻を設定してスケジュール投稿
   - X投稿用本文を生成（オプション）

## 機能一覧

### 認証・セッション管理
- ✅ **ログイン機能**
  - 固定パスワード認証（note123）
  - セッションIDによるユーザー識別
  - セッション有効性の自動検証
  - セッション切れ時の自動ログアウト

- ✅ **セッション別データ分離**
  - 各ユーザーに一意のセッションIDを発行
  - セッションIDごとにデータを完全分離
  - 不特定多数の利用に対応
  - 他のユーザーのデータにアクセス不可

### 設定管理
- ✅ **基本設定**
  - note.comのID（メールアドレス）とパスワード設定
  - OpenAI API Key設定
  - Gemini API Key設定
  - SQLiteデータベースに永続化（サーバー再起動後も保持）

- ✅ **プロンプト設定**
  - 文章の表現スタイル（明るい、丁寧、フランク）
  - 文章の長さ設定（1000-2000、2000-3000、3000-5000文字）
  - その他条件の自由入力
  - 設定の永続化

### 記事生成機能
- ✅ **テーマ別記事生成**
  - 20種類以上のテーマから選択
  - OpenAI / Gemini APIで記事を自動生成
  - プロンプト設定に基づいた記事生成
  - 生成された記事のプレビュー表示

- ✅ **Xトレンド記事生成**
  - X（Twitter）のトレンドを自動取得（twscrape使用）
  - トレンド一覧の表示（ツイート数付き）
  - トレンドとテーマを組み合わせて記事生成
  - トレンドの手動更新機能

- ✅ **手動記事生成・編集**
  - タイトルと本文を手動で入力
  - デフォルトで2000-3000文字のテンプレート
  - テーマの指定（オプション）
  - リアルタイム編集

### 記事管理機能
- ✅ **ダッシュボード**
  - 生成された記事の一覧表示
  - 記事のプレビュー（200文字まで）
  - 全文表示機能
  - 記事の削除機能
  - 投稿完了状態の表示（✓ 投稿完了バッジ）
  - 投稿日時の表示

### 投稿機能
- ✅ **即座に投稿**
  - ブラウザ自動操作による投稿
  - note.comへの自動ログイン
  - タイトルと本文の自動入力
  - 下書き保存の自動実行
  - 投稿完了状態の自動更新

- ✅ **スケジュール投稿**
  - 複数のスケジュールを同時登録可能
  - **毎日投稿**: 指定時刻に毎日自動投稿
  - **週次投稿**: 特定の曜日（月〜日）と時刻を指定
  - 時刻選択（時: 0-23、分: 0/15/30/45）をプルダウンで選択
  - スケジュール一覧の表示
  - スケジュールの削除機能
  - スケジュール実行時に記事を自動生成→投稿

- ✅ **投稿完了管理**
  - 投稿済み記事の視覚的表示（緑色のボーダー）
  - 投稿完了バッジ表示
  - 投稿日時の記録
  - 投稿済み記事の「投稿」ボタン非表示

### X投稿支援機能
- ✅ **X投稿用本文生成**
  - 記事からX投稿用の本文を自動生成
  - 適切なハッシュタグを自動付与
  - 文字数制限を考慮した生成
  - エモジの適切な使用

### ブラウザ自動化機能
- ✅ **note.com自動操作**
  - Playwrightによるブラウザ自動化
  - Windows環境対応（sync_playwright使用）
  - ログインページへの自動遷移
  - メールアドレス・パスワードの自動入力
  - 投稿ボタンの自動クリック
  - エディタページへの自動遷移
  - タイトル・本文の自動入力
  - 下書き保存ボタンの自動クリック
  - エラー時のスクリーンショット自動保存
  - 詳細なログ出力

### データ管理
- ✅ **データ永続化**
  - SQLiteデータベースによる設定情報の永続化
  - セッション情報の永続化
  - スケジュール情報の永続化
  - サーバー再起動後も設定が保持される

- ✅ **データ分離**
  - セッションIDごとの完全なデータ分離
  - 記事データのセッション別管理
  - 設定データのセッション別管理

### ユーザーインターフェース
- ✅ **レスポンシブデザイン**
  - モダンなUIデザイン
  - 直感的な操作
  - エラーメッセージの表示
  - ローディング状態の表示

- ✅ **ナビゲーション**
  - ダッシュボード
  - テーマ生成
  - トレンド生成
  - 手動編集
  - プロンプト設定
  - 設定
  - ログアウト

### エラーハンドリング
- ✅ **エラー処理**
  - API接続エラーの処理
  - 認証エラーの自動処理
  - ブラウザ操作エラーの詳細ログ
  - ユーザーフレンドリーなエラーメッセージ
  - スクリーンショットによるデバッグ支援

## ディレクトリ構成

```
note-draft-system/
├── backend/
│   ├── agents/          # 記事生成エージェント
│   │   ├── theme_agent.py
│   │   ├── trend_agent.py
│   │   └── x_post_agent.py
│   ├── services/        # サービス層
│   │   ├── note_service.py
│   │   └── auto_post_service.py
│   ├── main.py          # FastAPIアプリケーション
│   └── requirements.txt
├── frontend/
│   ├── src/
│   │   ├── components/  # 共通コンポーネント
│   │   ├── pages/       # ページコンポーネント
│   │   ├── services/    # API通信
│   │   └── App.js
│   └── package.json
└── README.md
```

## 注意事項

- **セッション管理**: 固定パスワード（note123）でログイン後、各ユーザーにセッションIDが発行されます
- **データ分離**: セッションIDごとにデータが分離され、他のユーザーのデータは見えません
- **データ永続化**: 設定情報（note.com認証情報、APIキー、プロンプト設定）はSQLiteデータベースに保存され、サーバー再起動後も保持されます
- **記事データ**: 記事データはセッション別に管理されますが、サーバー再起動で消去されます（設定情報のみ永続化）
- **note.comへの下書き投稿はブラウザスクレイピング（Playwright）を使用しています**
  - 初回起動時にPlaywrightブラウザのインストールが必要です
  - ヘッドレスモードで実行されますが、必要に応じて`headless=False`に変更して動作確認できます
  - note.comのUI変更により、セレクターの調整が必要になる場合があります
- twscrapeの初期設定が必要な場合があります（アカウント情報の設定など）
- APIキーは安全に管理してください
- ブラウザスクレイピングはnote.comの利用規約を遵守して使用してください

## トラブルシューティング

### バックエンドが起動しない
- Pythonのバージョンを確認（3.8以上）
- 依存関係が正しくインストールされているか確認
- ポート8000が使用されていないか確認

### フロントエンドが起動しない
- Node.jsのバージョンを確認（16以上）
- `npm install` が正常に完了したか確認
- ポート3000が使用されていないか確認

### API接続エラー
- バックエンドが起動しているか確認
- CORS設定を確認
- ブラウザのコンソールでエラーを確認

### 下書き投稿が失敗する
- Playwrightブラウザがインストールされているか確認（`playwright install chromium`）
- note.comのログイン情報が正しいか確認
- note.comのUIが変更されていないか確認（セレクターの調整が必要な場合があります）
- エラー時に自動保存されるスクリーンショット（`error_screenshot_*.png`）を確認
- デバッグのために`note_service.py`の`headless=False`に変更してブラウザの動作を確認

